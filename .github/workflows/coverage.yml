name: Coverage

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  core:
    name: Core Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/core test:run -- --coverage
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/core/coverage/lcov.info
          flag-name: core
          parallel: true

  react:
    name: React Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/react test:run -- --coverage
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/react/coverage/lcov.info
          flag-name: react
          parallel: true

  plugin-latex:
    name: Plugin Latex Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/plugin-latex test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/plugin-latex/coverage/lcov.info
          flag-name: plugin-latex
          parallel: true
        continue-on-error: true

  plugin-syntax-highlight:
    name: Plugin Syntax Highlight Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/plugin-syntax-highlight test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/plugin-syntax-highlight/coverage/lcov.info
          flag-name: plugin-syntax-highlight
          parallel: true
        continue-on-error: true

  plugin-media-preview:
    name: Plugin Media Preview Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/plugin-media-preview test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/plugin-media-preview/coverage/lcov.info
          flag-name: plugin-media-preview
          parallel: true
        continue-on-error: true

  plugin-turnstile:
    name: Plugin Turnstile Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/plugin-turnstile test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/plugin-turnstile/coverage/lcov.info
          flag-name: plugin-turnstile
          parallel: true
        continue-on-error: true

  plugin-auth-ethereum:
    name: Plugin Auth Ethereum Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/plugin-auth-ethereum test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/plugin-auth-ethereum/coverage/lcov.info
          flag-name: plugin-auth-ethereum
          parallel: true
        continue-on-error: true

  plugin-auth-solana:
    name: Plugin Auth Solana Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/plugin-auth-solana test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/plugin-auth-solana/coverage/lcov.info
          flag-name: plugin-auth-solana
          parallel: true
        continue-on-error: true

  svelte:
    name: Svelte Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @threadkit/svelte test:run -- --coverage
        continue-on-error: true
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: packages/svelte/coverage/lcov.info
          flag-name: svelte
          parallel: true
        continue-on-error: true

  rust:
    name: Rust Coverage
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Run tests with coverage
        working-directory: server
        env:
          REDIS_URL: redis://localhost:6379
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: server/lcov.info
          flag-name: rust
          parallel: true

  wordpress:
    name: WordPress Plugin Coverage
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: xdebug
          extensions: mysqli, zip
      - name: Install Composer dependencies
        working-directory: integrations/wordpress
        run: composer install --no-interaction --prefer-dist
      - name: Install WordPress test suite
        working-directory: integrations/wordpress
        run: bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1:3306 latest true
      - name: Run tests with coverage
        working-directory: integrations/wordpress
        run: vendor/bin/phpunit --coverage-clover=coverage.xml
      - name: Convert coverage to lcov
        working-directory: integrations/wordpress
        run: |
          composer require --dev php-coveralls/php-coveralls
          vendor/bin/php-coveralls -x coverage.xml -o coverage.lcov --json_path=/dev/null
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2.3.6
        with:
          file: integrations/wordpress/coverage.lcov
          flag-name: wordpress
          parallel: true

  finish:
    name: Finish Coveralls
    needs: [core, react, plugin-latex, plugin-syntax-highlight, plugin-media-preview, plugin-turnstile, plugin-auth-ethereum, plugin-auth-solana, svelte, rust, wordpress]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Finish Coveralls parallel build
        uses: coverallsapp/github-action@v2.3.6
        with:
          parallel-finished: true
          carryforward: core,react,plugin-latex,plugin-syntax-highlight,plugin-media-preview,plugin-turnstile,plugin-auth-ethereum,plugin-auth-solana,svelte,rust,wordpress
